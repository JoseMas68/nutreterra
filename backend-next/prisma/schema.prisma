// Esquema de Prisma para NutreTerra
// Base de datos: PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================
// USUARIOS Y AUTENTICACIÓN
// ========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  role          UserRole  @default(CUSTOMER)
  emailVerified DateTime?
  image         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  addresses Address[]
  orders    Order[]
  reviews   Review[]
  cart      Cart?
  menus     Menu[]

  @@map("users")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

model Address {
  id         String  @id @default(cuid())
  userId     String
  firstName  String
  lastName   String
  street     String
  city       String
  state      String
  postalCode String
  country    String  @default("ES")
  phone      String
  isDefault  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@map("addresses")
}

// ========================================
// PRODUCTOS Y CATEGORÍAS
// ========================================

model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  imageUrl    String?
  order       Int     @default(0)
  active      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  products Product[]

  @@map("categories")
}

model ProductLine {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String
  icon        String  // SVG path o código del icono
  order       Int     @default(0)
  active      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  products ProductProductLine[]

  @@map("product_lines")
}

model Product {
  id               String   @id @default(cuid())
  sku              String   @unique
  name             String
  slug             String   @unique
  description      String
  shortDescription String?
  price            Float
  compareAtPrice   Float?
  cost             Float?
  stock            Int      @default(0)
  lowStockAlert    Int      @default(5)
  weight           Float?
  imageUrl         String
  images           String[] @default([])
  featured         Boolean  @default(false)
  active           Boolean  @default(true)

  categoryId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  category     Category             @relation(fields: [categoryId], references: [id])
  tags         ProductTag[]
  productLines ProductProductLine[]
  cartItems    CartItem[]
  orderItems   OrderItem[]
  reviews      Review[]
  menuItems    MenuItem[]

  @@map("products")
}

model Tag {
  id   String @id @default(cuid())
  name String @unique
  slug String @unique

  createdAt DateTime @default(now())

  // Relaciones
  products ProductTag[]

  @@map("tags")
}

model ProductTag {
  productId String
  tagId     String

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@map("product_tags")
}

model ProductProductLine {
  productId     String
  productLineId String

  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  productLine ProductLine @relation(fields: [productLineId], references: [id], onDelete: Cascade)

  @@id([productId, productLineId])
  @@map("product_product_lines")
}

// ========================================
// CARRITO
// ========================================

model Cart {
  id     String @id @default(cuid())
  userId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String @id @default(cuid())
  cartId    String
  productId String
  quantity  Int    @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@map("cart_items")
}

// ========================================
// PEDIDOS
// ========================================

model Order {
  id            String      @id @default(cuid())
  orderNumber   String      @unique
  userId        String
  addressId     String
  status        OrderStatus @default(PENDING)
  paymentStatus String      @default("pending")
  paymentMethod String      @default("stripe")

  subtotal     Float
  shippingCost Float   @default(0)
  tax          Float   @default(0)
  total        Float

  notes        String?

  stripePaymentIntentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user    User        @relation(fields: [userId], references: [id])
  address Address     @relation(fields: [addressId], references: [id])
  items   OrderItem[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float
  subtotal  Float

  createdAt DateTime @default(now())

  // Relaciones
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

// ========================================
// RESEÑAS
// ========================================

model Review {
  id        String @id @default(cuid())
  userId    String
  productId String
  rating    Int
  title     String?
  comment   String?
  verified  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("reviews")
}

// ========================================
// PLANIFICADOR DE MENÚS
// ========================================

model Menu {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String? // Null si es un menú creado por admin
  isTemplate  Boolean  @default(false) // True si es una plantilla reutilizable
  isPublic    Boolean  @default(false) // True si otros usuarios pueden verlo
  startDate   DateTime? // Fecha de inicio del menú
  endDate     DateTime? // Fecha de fin del menú

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user  User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items MenuItem[]

  @@map("menus")
}

model MenuItem {
  id        String   @id @default(cuid())
  menuId    String
  productId String
  day       Int // Día de la semana (0=Lunes, 6=Domingo)
  mealType  MealType // Tipo de comida (BREAKFAST, LUNCH, DINNER, SNACK)
  order     Int      @default(0) // Orden dentro del mismo día y tipo de comida
  quantity  Int      @default(1)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  menu    Menu    @relation(fields: [menuId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("menu_items")
}

enum MealType {
  BREAKFAST // Desayuno
  LUNCH     // Comida
  DINNER    // Cena
  SNACK     // Snack
}
